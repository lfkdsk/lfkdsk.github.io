<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="Hugo 0.91.2" name="generator"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="Intra-Mind Traveler" name="author"/>
<meta content="https://lfkdsk.github.io/quick-learn-skip-list/" property="og:url"/>
<link href="https://lfkdsk.github.io/quick-learn-skip-list/" rel="canonical"/><link href="./img/favicon.ico" rel="apple-touch-icon"/>
<link href="./img/favicon.ico" rel="icon"/>
<link href="./img/favicon.ico" rel="shortcut"/><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/lfkdsk.github.io"
      },
      "articleSection" : "",
      "name" : "快速了解 SkipList",
      "headline" : "快速了解 SkipList",
      "description" : "快速的 SkipList 实现教程  在计算机科学领域，跳跃链表是一种数据结构，允许快速查询一个有序连续元素的数据链表。快速查询是通过维护一个多层次的链表，且每一层链表中的元素是前一层链表元素的子集。\n基于并联的链表，其效率可比拟于二叉查找树（对于大多数操作需要O(log n)平均时间）。\n基本上，跳跃列表是对有序的链表增加上附加的前进链接，增加是以随机化的方式进行的，所以在列表中的查找可以快速的跳过部分列表，因此得名。所有操作都以对数随机化的时间进行。 要查找一个目标元素，起步于头元素和顶层列表，并沿着每个链表搜索，直到到达小于或着等于目标的最后一个元素。通过跟踪起自目标直到到达在更高列表中出现的元素的反向查找路径，在每个链表中预期的步数显而易见是 1\/p。所以查找的总体代价是 O((log1\/p n) \/ p)，当p 是常数时是 O(log n)。通过选择不同 p 值，就可以在查找代价和存储代价之间作出权衡。\n插入和删除的实现非常像相应的链表操作，除了\u0026quot;高层\u0026quot;元素必须在多个链表中插入或删除之外。\n跳跃列表不像某些传统平衡树数据结构那样提供绝对的最坏情况性能保证，因为用来建造跳跃列表的扔硬币方法总有可能（尽管概率很小）生成一个糟糕的不平衡结构。但是在实际中它工作的很好，随机化平衡方案比在平衡二叉查找树中用的确定性平衡方案容易实现。跳跃列表在并行计算中也很有用，这里的插入可以在跳跃列表不同的部分并行的进行，而不用全局的数据结构重新平衡。\n​\t—— Wikipedia\n 以上就是 Wikipedia 中对 SkipList 的描述，从描述中和以往的了解我们可以得知，SkipList 是对 List 的一种加强，通过拔高某些 Node 的层次来达到快速搜索的目的，根据这个想法我们可以知道，这个有点类似于躺平的二叉搜索树，这套 快速实现教程 的目的，就是截取文章中讨论内容的重点部分，通过重点讨论其中的精要部分来达到快速实现的目的。\n搜索方法 我们知道 SkipList 的结构知道我们就知道应该怎么对这个东西进行搜索，首先是从最上层的开始搜索，根据 Key 的比较进行判断向哪个方向进行搜索：\nprivate SkipListNode\u0026lt;K, V\u0026gt; findNodeByKey(K key) { SkipListNode\u0026lt;K, V\u0026gt; head = headNode; while (true) { \/\/ 首先右侧节点不为空 并且当前节点比右侧节点大 ===\u0026gt; 我们可以往右侧进行查找  while (head.right.key != null \u0026amp;\u0026amp; key.compareTo(head.right.key) \u0026gt;= 0) { head = head.",
      "inLanguage" : "en-US",
      "author" : "Intra-Mind Traveler",
      "creator" : "Intra-Mind Traveler",
      "publisher": "Intra-Mind Traveler",
      "accountablePerson" : "Intra-Mind Traveler",
      "copyrightHolder" : "Intra-Mind Traveler",
      "copyrightYear" : "2017",
      "datePublished": "2017-09-11 23:52:38 \u002b0000 UTC",
      "dateModified" : "2017-09-11 23:52:38 \u002b0000 UTC",
      "url" : "https:\/\/lfkdsk.github.io\/quick-learn-skip-list\/",
      "keywords" : [ "数据结构","Blog", "lfkdsk's Blog", "lfkdsk", "刘丰恺" ]
  }
</script>
<title>快速了解 SkipList - lfkdsk's Blog</title>
<meta content="快速了解 SkipList - lfkdsk's Blog" property="og:title"/>
<meta content="article" property="og:type"/>
<meta content='快速的 SkipList 实现教程  在计算机科学领域，跳跃链表是一种数据结构，允许快速查询一个有序连续元素的数据链表。快速查询是通过维护一个多层次的链表，且每一层链表中的元素是前一层链表元素的子集。
基于并联的链表，其效率可比拟于二叉查找树（对于大多数操作需要O(log n)平均时间）。
基本上，跳跃列表是对有序的链表增加上附加的前进链接，增加是以随机化的方式进行的，所以在列表中的查找可以快速的跳过部分列表，因此得名。所有操作都以对数随机化的时间进行。 要查找一个目标元素，起步于头元素和顶层列表，并沿着每个链表搜索，直到到达小于或着等于目标的最后一个元素。通过跟踪起自目标直到到达在更高列表中出现的元素的反向查找路径，在每个链表中预期的步数显而易见是 1/p。所以查找的总体代价是 O((log1/p n) / p)，当p 是常数时是 O(log n)。通过选择不同 p 值，就可以在查找代价和存储代价之间作出权衡。
插入和删除的实现非常像相应的链表操作，除了"高层"元素必须在多个链表中插入或删除之外。
跳跃列表不像某些传统平衡树数据结构那样提供绝对的最坏情况性能保证，因为用来建造跳跃列表的扔硬币方法总有可能（尽管概率很小）生成一个糟糕的不平衡结构。但是在实际中它工作的很好，随机化平衡方案比在平衡二叉查找树中用的确定性平衡方案容易实现。跳跃列表在并行计算中也很有用，这里的插入可以在跳跃列表不同的部分并行的进行，而不用全局的数据结构重新平衡。
​	—— Wikipedia
 以上就是 Wikipedia 中对 SkipList 的描述，从描述中和以往的了解我们可以得知，SkipList 是对 List 的一种加强，通过拔高某些 Node 的层次来达到快速搜索的目的，根据这个想法我们可以知道，这个有点类似于躺平的二叉搜索树，这套 快速实现教程 的目的，就是截取文章中讨论内容的重点部分，通过重点讨论其中的精要部分来达到快速实现的目的。
搜索方法 我们知道 SkipList 的结构知道我们就知道应该怎么对这个东西进行搜索，首先是从最上层的开始搜索，根据 Key 的比较进行判断向哪个方向进行搜索：
private SkipListNode&lt;K, V&gt; findNodeByKey(K key) { SkipListNode&lt;K, V&gt; head = headNode; while (true) { // 首先右侧节点不为空 并且当前节点比右侧节点大 ===&gt; 我们可以往右侧进行查找  while (head.right.key != null &amp;&amp; key.compareTo(head.right.key) &gt;= 0) { head = head.' name="description"/>
<link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker" rel="stylesheet"/>
<link href="https://unpkg.com/flexboxgrid@6.3.1/dist/flexboxgrid.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/androidstudio.min.css" rel="stylesheet"/>
<link href="/css/paper.css" rel="stylesheet"/>
<link href="/css/index.css" rel="stylesheet"/>
<link href="/index.xml" rel="alternate" title="lfkdsk's Blog" type="application/rss+xml"/>
<link href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel="stylesheet"/>
<script>
    

    (function(undefined) {}).call('object' === typeof window && window || 'object' === typeof self && self || 'object' === typeof global && global || {});
  </script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-8TMSDJG47Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8TMSDJG47Q');
</script>
</head>
<body>
<article class="post Chinese" id="article">
<div class="row">
<div class="paper col-xs-12 col-md-8 col-md-offset-2 col-lg-8 col-lg-offset-2">
<a href="/">
<div class="head-line"></div>
</a>
<header class="post-header">
<h1 class="post-title">快速了解 SkipList</h1>
<div class="row">
<div class="col-xs-6">
<time class="post-date" datetime="2017-09-11 23:52:38 UTC">
                  11 Sep 2017
                </time>
</div>
<div class="col-xs-6">
<div class="post-author">
<a href="https://lfkdsk.github.io/" target="_blank">@Intra-Mind Traveler</a>
</div>
</div>
</div>
</header>
<div class="post-content markdown-body">
<h1 id="快速的-skiplist-实现教程">快速的 SkipList 实现教程</h1>
<blockquote>
<p>在计算机科学领域，<strong>跳跃链表</strong>是一种<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a>，允许快速查询一个<a href="https://zh.wikipedia.org/wiki/%E5%BA%8F%E5%88%97">有序连续</a>元素的数据链表。快速查询是通过维护一个多层次的链表，且每一层链表中的元素是前一层链表元素的子集。</p>
<p>基于并联的<a href="https://zh.wikipedia.org/wiki/%E9%93%BE%E8%A1%A8">链表</a>，其<a href="https://zh.wikipedia.org/w/index.php?title=%E6%95%88%E7%8E%87&amp;action=edit&amp;redlink=1">效率</a>可比拟于<a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91">二叉查找树</a>（对于大多数操作需要<a href="https://zh.wikipedia.org/wiki/%E5%A4%A7O%E7%AC%A6%E5%8F%B7">O</a>(log <em>n</em>)平均时间）。</p>
<p>基本上，跳跃列表是对有序的<a href="https://zh.wikipedia.org/wiki/%E9%93%BE%E8%A1%A8">链表</a>增加上附加的前进链接，增加是以<a href="https://zh.wikipedia.org/w/index.php?title=Randomization&amp;action=edit&amp;redlink=1">随机化</a>的方式进行的，所以在列表中的查找可以快速的跳过部分列表，因此得名。所有操作都以对数随机化的时间进行。
<img alt="skip" src="skip-list.png"/></p>
<p>要查找一个目标元素，起步于头元素和顶层列表，并沿着每个链表搜索，直到到达小于或着等于目标的最后一个元素。通过跟踪起自目标直到到达在更高列表中出现的元素的反向查找路径，在每个链表中预期的步数显而易见是 1/<em>p</em>。所以查找的总体代价是 O((log1/<em>p</em> n) / p)，当<em>p</em> 是常数时是 O(log <em>n</em>)。通过选择不同 <em>p</em> 值，就可以在查找代价和存储代价之间作出权衡。</p>
<p>插入和删除的实现非常像相应的链表操作，除了"高层"元素必须在多个链表中插入或删除之外。</p>
<p>跳跃列表不像某些传统<a href="https://zh.wikipedia.org/wiki/%E5%B9%B3%E8%A1%A1%E6%A0%91">平衡树</a>数据结构那样提供绝对的最坏情况性能保证，因为用来建造跳跃列表的扔硬币方法总有可能（尽管概率很小）生成一个糟糕的不平衡结构。但是在实际中它工作的很好，随机化平衡方案比在平衡二叉查找树中用的确定性平衡方案容易实现。跳跃列表在<a href="https://zh.wikipedia.org/wiki/%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97">并行计算</a>中也很有用，这里的插入可以在跳跃列表不同的部分并行的进行，而不用全局的数据结构重新平衡。</p>
<p>​																			——  Wikipedia</p>
</blockquote>
<p>以上就是 Wikipedia 中对 SkipList 的描述，从描述中和以往的了解我们可以得知，SkipList 是对 List 的一种加强，通过拔高某些 Node 的层次来达到快速搜索的目的，根据这个想法我们可以知道，这个有点类似于躺平的二叉搜索树，这套 <em>快速实现教程</em> 的目的，就是截取文章中讨论内容的重点部分，通过重点讨论其中的精要部分来达到快速实现的目的。</p>
<h2 id="搜索方法">搜索方法</h2>
<p>我们知道 SkipList 的结构知道我们就知道应该怎么对这个东西进行搜索，首先是从最上层的开始搜索，根据 <strong>Key</strong> 的比较进行判断向哪个方向进行搜索：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findNodeByKey</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> head <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#75715e">// 首先右侧节点不为空 并且当前节点比右侧节点大 ===&gt; 我们可以往右侧进行查找
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>head<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">.</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>head<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">)</span> <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                head <span style="color:#f92672">=</span> head<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
		  <span style="color:#75715e">// 向下查找 ===&gt; 直到最下一层
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>head<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                head <span style="color:#f92672">=</span> head<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> head<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

</code></pre></div><p>根据 <strong>从左到右，从上到下</strong> 的方法，我们就能查找到对应的节点，如果本身 List 中没有对应的节点，我们会获得 <strong>比所搜索的 Key 最小的一个节点</strong> 这样我们无论是存放还是搜索都很方便。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">search</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">=</span> findNodeByKey<span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> p<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

</code></pre></div><p>暴露在外层的方法，可以根据拿到的 Node 是 <strong>所找的节点 还是 接近的节点</strong> 来判断返回。</p>
<h2 id="存放方法">存放方法</h2>
<p>普通的存放方法其实是和普通的 <em>LinkedList</em> 是类似的，因为毕竟无论是几层的 <em>Level</em>  最终数据都是存储在 <strong>最下面一层的</strong>，所以我们存储的开始就和普通的链表没有区别，但是由于有 <strong>层次</strong> 的设定，所以说我们每个 Node 类都有 <strong>上下左右</strong> 四个方向的功能：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SkipListNode</span><span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> Entry<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">/**
</span><span style="color:#75715e">         * point to =&gt;
</span><span style="color:#75715e">         */</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> up<span style="color:#f92672">,</span> down<span style="color:#f92672">,</span> left<span style="color:#f92672">,</span> right<span style="color:#f92672">;</span>

        K key<span style="color:#f92672">;</span>
        V value<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>我们可以先来简单的实现普通的存储方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">,</span> V value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnsupportedOperationException<span style="color:#f92672">(</span><span style="color:#e6db74">"key could not be null"</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
		<span style="color:#75715e">// 找到对应的 Key-Node 或者是最近的节点
</span><span style="color:#75715e"></span>        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">=</span> findNodeByKey<span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
        <span style="color:#75715e">// 如果存在这个节点只需要替换 Value 就可以了
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            p<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">return</span> value<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
		<span style="color:#75715e">// 把新节点放在 p 节点后面
</span><span style="color:#75715e"></span>        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> q <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span>key<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>
      	<span style="color:#75715e">// 一些绑定而已
</span><span style="color:#75715e"></span>        backLink<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> q<span style="color:#f92672">);</span>
        nodeCounts<span style="color:#f92672">++;</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</code></pre></div><p>这部分只是普通的 <em>LinkedList</em> 的存取方法，然后更新一些数据而已，刚才我们从 <em>SkipList</em> 的介绍中可以得出，<em>SkipList</em> 是一个概率型的数据结构，每次存储的时候 <strong>随机进行把 level 把高的操作</strong> ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java">        <span style="color:#75715e">// current level
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> currentLevel <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextDouble</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> PROBABILITY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 当 `当前拔高的层次` 超过已有的层次，新建层次
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentLevel <span style="color:#f92672">&gt;=</span> listLevels<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                createNewLevel<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// 向左搜索 =====&gt; 直到一个有上层的节点
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">up</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// 这个 corner case 是为了解决此时还没有上面的层次
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// p equal header node
</span><span style="color:#75715e"></span>                    createNewLevel<span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// 向上拔高一层
</span><span style="color:#75715e"></span>            p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">up</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// 只保存 key
</span><span style="color:#75715e"></span>            SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span>key<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
			
          	<span style="color:#75715e">// 各方面链接
</span><span style="color:#75715e"></span>            backLink<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            verticalLink<span style="color:#f92672">(</span>e<span style="color:#f92672">,</span> q<span style="color:#f92672">);</span>
          	<span style="color:#75715e">// 交换节点有助于多层链接
</span><span style="color:#75715e"></span>            q <span style="color:#f92672">=</span> e<span style="color:#f92672">;</span>
            currentLevel<span style="color:#f92672">++;</span>
        <span style="color:#f92672">}</span>
</code></pre></div><p>新建层次：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createNewLevel</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        listLevels<span style="color:#f92672">++;</span>

        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> p1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> p2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>

        horizontalLink<span style="color:#f92672">(</span>p1<span style="color:#f92672">,</span> p2<span style="color:#f92672">);</span>

        verticalLink<span style="color:#f92672">(</span>p1<span style="color:#f92672">,</span> headNode<span style="color:#f92672">);</span>
        verticalLink<span style="color:#f92672">(</span>p2<span style="color:#f92672">,</span> tailNode<span style="color:#f92672">);</span>

        headNode <span style="color:#f92672">=</span> p1<span style="color:#f92672">;</span>
        tailNode <span style="color:#f92672">=</span> p2<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h2 id="删除方法">删除方法</h2>
<p>删除操作肯定也是和 <em>Search</em> 操作紧密衔接的，我们 <strong>先找到最底层的节点，然后从下到上逐层删除索引</strong> 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>Object key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      	<span style="color:#75715e">// nest noe
</span><span style="color:#75715e"></span>        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> node <span style="color:#f92672">=</span> findNodeByKey<span style="color:#f92672">((</span>K<span style="color:#f92672">)</span> key<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
          <span style="color:#75715e">// 找到的 节点的部分
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>key<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
			
          	<span style="color:#75715e">// 从下到上不断读取节点合并两侧的节点
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> left <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
                SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> right <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>left <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> right <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    horizontalLink<span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> right<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                node <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">up</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            node <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>
			<span style="color:#75715e">// 从上到下删除空的层次 —— 这个操作其实不是必要的，
</span><span style="color:#75715e"></span>          	<span style="color:#75715e">// 很多的实现仅仅是删除最上层的空层
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>tailNode<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> oldHeadNode <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>
                SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> oldTailNode <span style="color:#f92672">=</span> tailNode<span style="color:#f92672">;</span>

                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">headNode</span> <span style="color:#f92672">=</span> oldHeadNode<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tailNode</span> <span style="color:#f92672">=</span> oldTailNode<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listLevels</span><span style="color:#f92672">--;</span>

                node <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>

                oldHeadNode <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                oldTailNode <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

</code></pre></div><p>删除的内容就比较简单了：</p>
<ul>
<li>获取最下层节点</li>
<li>从下到上不断读取节点合并两侧的节点</li>
<li>删除空层</li>
</ul>
<h2 id="你学到了什么">你学到了什么</h2>
<ul>
<li>一种新的搜索和存储的数据结构</li>
<li>快速构建 <em>Skip-List</em> 数据结构的思路和组成方法</li>
</ul>
<h3 id="全部代码">全部代码</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> set<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> com.sun.org.apache.bcel.internal.classfile.ExceptionTable<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.util.*<span style="color:#f92672">;</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * Created by liufengkai on 2017/9/11.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SkipList</span><span style="color:#f92672">&lt;</span>K <span style="color:#66d9ef">extends</span> Comparable<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">&gt;,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> Map<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Probability to flow one node up
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">double</span> PROBABILITY <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * head / tail
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> headNode<span style="color:#f92672">,</span> tailNode<span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * all node counts
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> nodeCounts<span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * all list level
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> listLevels<span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * random util
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> Random random<span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Key Set
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">&gt;</span> keySet <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;();</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Value Set
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> valueSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;();</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SkipList</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">random</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> nodeCounts<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> nodeCounts <span style="color:#f92672">==</span> 0<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>Object key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> get<span style="color:#f92672">(</span>key<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">containsValue</span><span style="color:#f92672">(</span>Object value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SkipListNode node <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span> node <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> node <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>value<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>Object key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnsupportedOperationException<span style="color:#f92672">(</span><span style="color:#e6db74">"key could not be null"</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> node <span style="color:#f92672">=</span> search<span style="color:#f92672">((</span>K<span style="color:#f92672">)</span> key<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> node <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">,</span> V value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnsupportedOperationException<span style="color:#f92672">(</span><span style="color:#e6db74">"key could not be null"</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">=</span> findNodeByKey<span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
        <span style="color:#75715e">// change value | equal key
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            p<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">return</span> value<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> q <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span>key<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>
        backLink<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> q<span style="color:#f92672">);</span>
        nodeCounts<span style="color:#f92672">++;</span>

        <span style="color:#75715e">// current level
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> currentLevel <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextDouble</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> PROBABILITY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentLevel <span style="color:#f92672">&gt;=</span> listLevels<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                createNewLevel<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// find up level node to bind it
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">up</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// p equal header node
</span><span style="color:#75715e"></span>                    createNewLevel<span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// upper level node
</span><span style="color:#75715e"></span>            p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">up</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// save key
</span><span style="color:#75715e"></span>            SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span>key<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>

            backLink<span style="color:#f92672">(</span>p<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            verticalLink<span style="color:#f92672">(</span>e<span style="color:#f92672">,</span> q<span style="color:#f92672">);</span>
            q <span style="color:#f92672">=</span> e<span style="color:#f92672">;</span>
            currentLevel<span style="color:#f92672">++;</span>
        <span style="color:#f92672">}</span>

        keySet<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
        valueSet<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>value<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> value<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createNewLevel</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        listLevels<span style="color:#f92672">++;</span>

        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> p1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> p2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>

        horizontalLink<span style="color:#f92672">(</span>p1<span style="color:#f92672">,</span> p2<span style="color:#f92672">);</span>

        verticalLink<span style="color:#f92672">(</span>p1<span style="color:#f92672">,</span> headNode<span style="color:#f92672">);</span>
        verticalLink<span style="color:#f92672">(</span>p2<span style="color:#f92672">,</span> tailNode<span style="color:#f92672">);</span>

        headNode <span style="color:#f92672">=</span> p1<span style="color:#f92672">;</span>
        tailNode <span style="color:#f92672">=</span> p2<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>Object key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> node <span style="color:#f92672">=</span> findNodeByKey<span style="color:#f92672">((</span>K<span style="color:#f92672">)</span> key<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>key<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>

            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> left <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
                SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> right <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>left <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> right <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    horizontalLink<span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> right<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                node <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">up</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            node <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>

            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>tailNode<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> oldHeadNode <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>
                SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> oldTailNode <span style="color:#f92672">=</span> tailNode<span style="color:#f92672">;</span>

                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">headNode</span> <span style="color:#f92672">=</span> oldHeadNode<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tailNode</span> <span style="color:#f92672">=</span> oldTailNode<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listLevels</span><span style="color:#f92672">--;</span>

                node <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>

                oldHeadNode <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                oldTailNode <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>


    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>Object key<span style="color:#f92672">,</span> Object value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> remove<span style="color:#f92672">(</span>key<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">putAll</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> K<span style="color:#f92672">,</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">extends</span> V<span style="color:#f92672">&gt;</span> m<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Entry<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> K<span style="color:#f92672">,</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">extends</span> V<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> m<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            put<span style="color:#f92672">(</span>entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">(),</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clear</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">headNode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tailNode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipListNode<span style="color:#f92672">&lt;&gt;(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nodeCounts</span> <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">listLevels</span> <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

        <span style="color:#75715e">// horizontal link head === tail nodes
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">horizontalLink</span><span style="color:#f92672">(</span>headNode<span style="color:#f92672">,</span> tailNode<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Set<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">keySet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> keySet<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Collection<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">values</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> valueSet<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Set<span style="color:#f92672">&lt;</span>Entry<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">entrySet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        Set<span style="color:#f92672">&lt;</span>Entry<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;&gt;</span> set <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> node <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span> node <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> node <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> set<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * add front link after node
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param front front-node
</span><span style="color:#75715e">     * @param back  back-node
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">backLink</span><span style="color:#f92672">(</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> front<span style="color:#f92672">,</span> SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> back<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        back<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> front<span style="color:#f92672">;</span>
        back<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> front<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>
        front<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> back<span style="color:#f92672">;</span>
        front<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> back<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>


    <span style="color:#66d9ef">private</span> SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findNodeByKey</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="color:#75715e">//        System.out.println("Start Search: ");
</span><span style="color:#75715e"></span>        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> head <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>head<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">.</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>head<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">)</span> <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                head <span style="color:#f92672">=</span> head<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>
<span style="color:#75715e">//                System.out.println(head);
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>head<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                head <span style="color:#f92672">=</span> head<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span><span style="color:#f92672">;</span>
<span style="color:#75715e">//                System.out.println(head);
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> head<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">search</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">=</span> findNodeByKey<span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> p<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Horizontal Link
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param left  left node
</span><span style="color:#75715e">     * @param right right node
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">horizontalLink</span><span style="color:#f92672">(</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> left<span style="color:#f92672">,</span> SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> right<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        left<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> right<span style="color:#f92672">;</span>
        right<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> left<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Vertical Link
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param up   up node
</span><span style="color:#75715e">     * @param down down node
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">verticalLink</span><span style="color:#f92672">(</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> up<span style="color:#f92672">,</span> SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> down<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        up<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span> <span style="color:#f92672">=</span> down<span style="color:#f92672">;</span>
        down<span style="color:#f92672">.</span><span style="color:#a6e22e">up</span> <span style="color:#f92672">=</span> up<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    String <span style="color:#a6e22e">debugStructure</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        List<span style="color:#f92672">&lt;</span>List<span style="color:#f92672">&lt;</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;&gt;&gt;</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">int</span> currentLevel <span style="color:#f92672">=</span> listLevels<span style="color:#f92672">;</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> node <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentLevel <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">)</span> <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>

            List<span style="color:#f92672">&lt;</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;&gt;</span> levelList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;&gt;();</span>

            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                levelList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
                node <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            currentLevel<span style="color:#f92672">--;</span>

            <span style="color:#66d9ef">int</span> times <span style="color:#f92672">=</span> listLevels <span style="color:#f92672">-</span> currentLevel<span style="color:#f92672">;</span>
            node <span style="color:#f92672">=</span> headNode<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>times <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                node <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">down</span><span style="color:#f92672">;</span>
                times<span style="color:#f92672">--;</span>
            <span style="color:#f92672">}</span>

            list<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>levelList<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        StringBuilder builder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> list<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            List<span style="color:#f92672">&lt;</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;&gt;</span> level <span style="color:#f92672">=</span> list<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>

            builder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">"Level : "</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>listLevels <span style="color:#f92672">-</span> i<span style="color:#f92672">))</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">" &gt; \t"</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> kvSkipListNode <span style="color:#f92672">:</span> level<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

                builder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>kvSkipListNode<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">)</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">"\t"</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            builder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">"\n"</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">==</span> list<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                builder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">"            \t"</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> kvSkipListNode <span style="color:#f92672">:</span> level<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

                    builder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>kvSkipListNode<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">)</span>
                            <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">"\t"</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> builder<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Node in Skip List
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param &lt;V&gt; Type
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SkipListNode</span><span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> Entry<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">/**
</span><span style="color:#75715e">         * point to =&gt;
</span><span style="color:#75715e">         */</span>
        SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> up<span style="color:#f92672">,</span> down<span style="color:#f92672">,</span> left<span style="color:#f92672">,</span> right<span style="color:#f92672">;</span>

        K key<span style="color:#f92672">;</span>
        V value<span style="color:#f92672">;</span>

        SkipListNode<span style="color:#f92672">(</span>K key<span style="color:#f92672">,</span> V value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> key<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> K <span style="color:#a6e22e">getKey</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> key<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">getValue</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> value<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">setValue</span><span style="color:#f92672">(</span>V value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>Object o<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span> <span style="color:#f92672">==</span> o<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>o <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>o <span style="color:#66d9ef">instanceof</span> SkipListNode<span style="color:#f92672">&lt;?,</span> <span style="color:#f92672">?&gt;))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> ent<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                ent <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SkipListNode<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;)</span> o<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClassCastException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>ent<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">==</span> key<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>ent<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span> <span style="color:#f92672">==</span> value<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">"SkipListNode{"</span> <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">"key="</span> <span style="color:#f92672">+</span> key <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">", value="</span> <span style="color:#f92672">+</span> value <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">'}'</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="测试代码和结果">测试代码和结果</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SkipListTest</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testSkip</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        SkipList<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SkipList<span style="color:#f92672">&lt;&gt;();</span>
        Random random <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> 5<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            list<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>Math<span style="color:#f92672">.</span><span style="color:#a6e22e">abs</span><span style="color:#f92672">(</span>random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">()</span> <span style="color:#f92672">%</span> 10<span style="color:#f92672">),</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">"lfk"</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>list<span style="color:#f92672">.</span><span style="color:#a6e22e">debugStructure</span><span style="color:#f92672">());</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Integer key <span style="color:#f92672">:</span> list<span style="color:#f92672">.</span><span style="color:#a6e22e">keySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"========&gt; remove key :"</span> <span style="color:#f92672">+</span> key <span style="color:#f92672">+</span> <span style="color:#e6db74">" &lt;========= "</span><span style="color:#f92672">);</span>
            list<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>list<span style="color:#f92672">.</span><span style="color:#a6e22e">debugStructure</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>测试结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java">Level <span style="color:#f92672">:</span> 2 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	4	<span style="color:#66d9ef">null</span>	
Level <span style="color:#f92672">:</span> 1 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	4	<span style="color:#66d9ef">null</span>	
Level <span style="color:#f92672">:</span> 0 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	2	3	4	9	<span style="color:#66d9ef">null</span>	
            	<span style="color:#66d9ef">null</span>	3lfk	4lfk	2lfk	1lfk	<span style="color:#66d9ef">null</span>	
<span style="color:#f92672">========&gt;</span> remove key <span style="color:#f92672">:</span>2 <span style="color:#f92672">&lt;=========</span> 
Level <span style="color:#f92672">:</span> 2 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	4	<span style="color:#66d9ef">null</span>	
Level <span style="color:#f92672">:</span> 1 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	4	<span style="color:#66d9ef">null</span>	
Level <span style="color:#f92672">:</span> 0 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	3	4	9	<span style="color:#66d9ef">null</span>	
            	<span style="color:#66d9ef">null</span>	4lfk	2lfk	1lfk	<span style="color:#66d9ef">null</span>	
<span style="color:#f92672">========&gt;</span> remove key <span style="color:#f92672">:</span>3 <span style="color:#f92672">&lt;=========</span> 
Level <span style="color:#f92672">:</span> 2 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	4	<span style="color:#66d9ef">null</span>	
Level <span style="color:#f92672">:</span> 1 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	4	<span style="color:#66d9ef">null</span>	
Level <span style="color:#f92672">:</span> 0 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	4	9	<span style="color:#66d9ef">null</span>	
            	<span style="color:#66d9ef">null</span>	2lfk	1lfk	<span style="color:#66d9ef">null</span>	
<span style="color:#f92672">========&gt;</span> remove key <span style="color:#f92672">:</span>4 <span style="color:#f92672">&lt;=========</span> 
Level <span style="color:#f92672">:</span> 0 <span style="color:#f92672">&gt;</span> 	<span style="color:#66d9ef">null</span>	9	<span style="color:#66d9ef">null</span>	
            	<span style="color:#66d9ef">null</span>	1lfk	<span style="color:#66d9ef">null</span>	
<span style="color:#f92672">========&gt;</span> remove key <span style="color:#f92672">:</span>9 <span style="color:#f92672">&lt;=========</span> 
</code></pre></div>
</div>
<p>Subscribe：<a href="https://lfkdsk.github.io/index.xml" target="_blank">lfkdsk's Blog</a></p>
<div style="height:50px"></div>
<div class="post-comments">
<div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://lfkdsk.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript>Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>
</div>
</article>
<script src="/js/highlight.pack.js"></script>
<script src="https://unpkg.com/quicklink@0.1.1/dist/quicklink.umd.js"></script>
<script>
  hljs.initHighlightingOnLoad();
  
  var posts = document.getElementById('posts-list');
  posts && quicklink({
    el: posts,
    priority: true,
  });
</script>
</body>
</html>
