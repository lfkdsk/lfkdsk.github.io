<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="Hugo 0.91.2" name="generator"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="Intra-Mind Traveler" name="author"/>
<meta content="https://lfkdsk.github.io/redex-rewrite-kotlin/" property="og:url"/>
<link href="https://lfkdsk.github.io/redex-rewrite-kotlin/" rel="canonical"/><link href="./img/favicon.ico" rel="apple-touch-icon"/>
<link href="./img/favicon.ico" rel="icon"/>
<link href="./img/favicon.ico" rel="shortcut"/><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/lfkdsk.github.io"
      },
      "articleSection" : "",
      "name" : "Redex: Rewrite Kotlin SingletonInstance Pass",
      "headline" : "Redex: Rewrite Kotlin SingletonInstance Pass",
      "description" : "Introduction When Kotlin compile a class with lambda inline to JVM bytecode, kotlin compiler backend will generate a INSTANCE field in generated bytecode. Such as :\nimport java.util.* import kotlinx.coroutines.* class KotlinLambdaInline { var sink: Long = 0 fun doCalc(addfn: (a: Long, b: Long) -\u0026gt; Long): Long { return addfn(123L, 456L) } fun foo() { sink = doCalc { a: Long, b: Long -\u0026gt; a \u002b b } } } Will generate bytecode like : https:\/\/gist.",
      "inLanguage" : "en-US",
      "author" : "Intra-Mind Traveler",
      "creator" : "Intra-Mind Traveler",
      "publisher": "Intra-Mind Traveler",
      "accountablePerson" : "Intra-Mind Traveler",
      "copyrightHolder" : "Intra-Mind Traveler",
      "copyrightYear" : "2021",
      "datePublished": "2021-09-16 18:24:14 \u002b0000 UTC",
      "dateModified" : "2021-09-16 18:24:14 \u002b0000 UTC",
      "url" : "https:\/\/lfkdsk.github.io\/redex-rewrite-kotlin\/",
      "keywords" : [ "Blog", "lfkdsk's Blog", "lfkdsk", "刘丰恺" ]
  }
</script>
<title>Redex: Rewrite Kotlin SingletonInstance Pass - lfkdsk's Blog</title>
<meta content="Redex: Rewrite Kotlin SingletonInstance Pass - lfkdsk's Blog" property="og:title"/>
<meta content="article" property="og:type"/>
<meta content="Introduction When Kotlin compile a class with lambda inline to JVM bytecode, kotlin compiler backend will generate a INSTANCE field in generated bytecode. Such as :
import java.util.* import kotlinx.coroutines.* class KotlinLambdaInline { var sink: Long = 0 fun doCalc(addfn: (a: Long, b: Long) -&gt; Long): Long { return addfn(123L, 456L) } fun foo() { sink = doCalc { a: Long, b: Long -&gt; a + b } } } Will generate bytecode like : https://gist." name="description"/>
<link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker" rel="stylesheet"/>
<link href="https://unpkg.com/flexboxgrid@6.3.1/dist/flexboxgrid.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/androidstudio.min.css" rel="stylesheet"/>
<link href="/css/paper.css" rel="stylesheet"/>
<link href="/css/index.css" rel="stylesheet"/>
<link href="/index.xml" rel="alternate" title="lfkdsk's Blog" type="application/rss+xml"/>
<link href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel="stylesheet"/>
<script>
    

    (function(undefined) {}).call('object' === typeof window && window || 'object' === typeof self && self || 'object' === typeof global && global || {});
  </script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-8TMSDJG47Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8TMSDJG47Q');
</script>
</head>
<body>
<article class="post Chinese" id="article">
<div class="row">
<div class="paper col-xs-12 col-md-8 col-md-offset-2 col-lg-8 col-lg-offset-2">
<a href="/">
<div class="head-line"></div>
</a>
<header class="post-header">
<h1 class="post-title">Redex: Rewrite Kotlin SingletonInstance Pass</h1>
<div class="row">
<div class="col-xs-6">
<time class="post-date" datetime="2021-09-16 18:24:14 UTC">
                  16 Sep 2021
                </time>
</div>
<div class="col-xs-6">
<div class="post-author">
<a href="https://lfkdsk.github.io/" target="_blank">@Intra-Mind Traveler</a>
</div>
</div>
</div>
</header>
<div class="post-content markdown-body">
<h2 id="introduction">Introduction</h2>
<p>When Kotlin compile a class with lambda inline to JVM bytecode, kotlin compiler backend will generate a INSTANCE field in generated bytecode. Such as :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">import</span> java.util.*
<span style="color:#66d9ef">import</span> kotlinx.coroutines.*

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KotlinLambdaInline</span> {
  <span style="color:#66d9ef">var</span> sink: Long = <span style="color:#ae81ff">0</span>

  <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">doCalc</span>(addfn: (a: Long, b: Long) <span style="color:#f92672">-&gt;</span> Long): Long {
    <span style="color:#66d9ef">return</span> addfn(<span style="color:#ae81ff">123L</span>, <span style="color:#ae81ff">456L</span>)
  }

  <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">foo</span>() {
    sink = doCalc { a: Long, b: Long <span style="color:#f92672">-&gt;</span> a + b }
  }
}
</code></pre></div><p>Will generate bytecode like :
<a href="https://gist.github.com/lfkdsk/41fe56a59365ad73cf430c6ef94e91df">https://gist.github.com/lfkdsk/41fe56a59365ad73cf430c6ef94e91df</a></p>
<p><img alt="" src="kotlin-decompile.png"/></p>
<p>RewriteKotlinSingletonInstancePass will remove these singleton instance in some cases.</p>
<h2 id="optimization">Optimization</h2>
<p>Optimize Kotlin non-capturing Lambda · facebook/redex@1da6807
This pass will remove INSTANCE in following several conditions.</p>
<ul>
<li>Single use for the instance field</li>
<li>Anonymous class is final</li>
<li>Anonymous class has single <!-- raw HTML omitted --> method</li>
<li><!-- raw HTML omitted --> method does not have any side effects</li>
<li>Anonymous class does not have any ifields
This would allow subsequent passes to optimize it.</li>
</ul>
<h3 id="step-1-collect-kotlin-lambda-instance-usage">Step 1: Collect Kotlin Lambda INSTANCE Usage</h3>
<p>Collect Kotlin noncapturing Lambda which would have an INSTANCE field of the same type and is initialized in <!-- raw HTML omitted -->. Collect all such Lambda.
Focus on following closure :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-cpp" data-lang="cpp">  walk<span style="color:#f92672">::</span>parallel<span style="color:#f92672">::</span>classes(scope, [<span style="color:#f92672">&amp;</span>](DexClass<span style="color:#f92672">*</span> cls) {
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>can_rename(cls) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>can_delete(cls)) {
      <span style="color:#66d9ef">return</span>;
    }
    <span style="color:#75715e">// has instance field just check field name == 'INSTANCE'
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">auto</span> instance <span style="color:#f92672">=</span> has_instance_field(cls, m_instance);
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>instance) {
      <span style="color:#66d9ef">return</span>;
    }
    <span style="color:#75715e">// another closure check cls has side effects.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (do_not_consider_type(cls)) {
      <span style="color:#66d9ef">return</span>;
    }
    <span style="color:#66d9ef">if</span> (concurrent_instance_map.count(instance)) {
      <span style="color:#66d9ef">return</span>;
    }
    std<span style="color:#f92672">::</span>set<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span>IRInstruction<span style="color:#f92672">*</span>, DexMethod<span style="color:#f92672">*&gt;&gt;</span> insns;
    concurrent_instance_map.emplace(instance, insns);
  });

</code></pre></div><p>Check side effects:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-cpp" data-lang="cpp">  <span style="color:#66d9ef">auto</span> iterable <span style="color:#f92672">=</span> cfg<span style="color:#f92672">::</span>InstructionIterable(<span style="color:#f92672">*</span>cfg);
  side_effects<span style="color:#f92672">::</span>Summary summary(side_effects<span style="color:#f92672">::</span>EFF_NONE, {});
  side_effects<span style="color:#f92672">::</span>InvokeToSummaryMap summary_map;

  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> iterable.begin(); it <span style="color:#f92672">!=</span> iterable.end(); it<span style="color:#f92672">++</span>) {
    <span style="color:#66d9ef">auto</span> insn <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>insn;
    <span style="color:#66d9ef">if</span> (insn<span style="color:#f92672">-&gt;</span>opcode() <span style="color:#f92672">!=</span> OPCODE_INVOKE_DIRECT) {
      <span style="color:#66d9ef">continue</span>;
    }
    <span style="color:#75715e">// Check lambda-init in bytecode 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (safe_base_invoke.count(insn<span style="color:#f92672">-&gt;</span>get_method())) {
      summary_map.emplace(insn, summary);
      <span style="color:#66d9ef">continue</span>;
    }
  }

  reaching_defs<span style="color:#f92672">::</span>MoveAwareFixpointIterator reaching_defs_iter(<span style="color:#f92672">*</span>cfg);
  reaching_defs_iter.run({});

  local_pointers<span style="color:#f92672">::</span>FixpointIterator fp_iter(<span style="color:#f92672">*</span>cfg);
  fp_iter.run({});

  <span style="color:#66d9ef">auto</span> side_effect_summary <span style="color:#f92672">=</span>
      side_effects<span style="color:#f92672">::</span>SummaryBuilder(summary_map,
                                   fp_iter,
                                   code,
                                   <span style="color:#f92672">&amp;</span>reaching_defs_iter,
                                   <span style="color:#75715e">/* analyze_external_reads */</span> true)
          .build();

  <span style="color:#66d9ef">return</span> side_effect_summary.is_pure();
</code></pre></div><h3 id="step-2-remove-escaping-instance">Step 2: Remove escaping instance</h3>
<p>Filter out any INSTANCE that might escape and whose use we might not be able to track.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-cpp" data-lang="cpp">              <span style="color:#75715e">// If there is more SPUT otherthan the initial one.
</span><span style="color:#75715e"></span>              <span style="color:#66d9ef">if</span> (opcode<span style="color:#f92672">::</span>is_an_sput(insn<span style="color:#f92672">-&gt;</span>opcode())) {
                <span style="color:#66d9ef">if</span> (method<span style="color:#f92672">::</span>is_clinit(method) <span style="color:#f92672">&amp;&amp;</span>
                    method<span style="color:#f92672">-&gt;</span>get_class() <span style="color:#f92672">==</span> field<span style="color:#f92672">-&gt;</span>get_type()) {
                  <span style="color:#66d9ef">continue</span>;
                }
                <span style="color:#75715e">// Erase if the field is written elsewhere.
</span><span style="color:#75715e"></span>                concurrent_instance_map.erase(field);
                <span style="color:#66d9ef">continue</span>;
              }
</code></pre></div><p>Erase from map if this field be visited multi-times except cinit function.</p>
<h3 id="step-3-do-tranformer">Step 3: do tranformer</h3>
<ol>
<li>Remove INSTANCE from class</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-cpp" data-lang="cpp">      <span style="color:#66d9ef">if</span> (method<span style="color:#f92672">::</span>is_clinit(meth)) {
        cfg<span style="color:#f92672">::</span>ScopedCFG cfg(meth<span style="color:#f92672">-&gt;</span>get_code());
        cfg<span style="color:#f92672">::</span>CFGMutation m(<span style="color:#f92672">*</span>cfg);
        TRACE(KOTLIN_INSTANCE, <span style="color:#ae81ff">5</span>, <span style="color:#e6db74">"%s &lt;clinit&gt; before</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s"</span>, SHOW(cls),
              SHOW(<span style="color:#f92672">*</span>cfg));
        <span style="color:#66d9ef">auto</span> iterable <span style="color:#f92672">=</span> cfg<span style="color:#f92672">::</span>InstructionIterable(<span style="color:#f92672">*</span>cfg);
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> insn_it <span style="color:#f92672">=</span> iterable.begin(); insn_it <span style="color:#f92672">!=</span> iterable.end();
             insn_it<span style="color:#f92672">++</span>) {
          <span style="color:#66d9ef">auto</span> insn <span style="color:#f92672">=</span> insn_it<span style="color:#f92672">-&gt;</span>insn;
          <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>opcode<span style="color:#f92672">::</span>is_an_sput(insn<span style="color:#f92672">-&gt;</span>opcode()) <span style="color:#f92672">||</span>
              insn<span style="color:#f92672">-&gt;</span>get_field() <span style="color:#f92672">!=</span> field) {
            <span style="color:#66d9ef">continue</span>;
          }

          m.remove(insn_it);
          stats.kotlin_instance_fields_removed<span style="color:#f92672">++</span>;
        }
</code></pre></div><ol start="2">
<li>Convert INSTANCE read to new instance creation</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-cpp" data-lang="cpp">        <span style="color:#66d9ef">auto</span> move_result_it <span style="color:#f92672">=</span> cfg<span style="color:#f92672">-&gt;</span>move_result_of(insn_it);
        IRInstruction<span style="color:#f92672">*</span> new_isn <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> IRInstruction(OPCODE_NEW_INSTANCE);
        new_isn<span style="color:#f92672">-&gt;</span>set_type(cls<span style="color:#f92672">-&gt;</span>get_type());
        IRInstruction<span style="color:#f92672">*</span> mov_result <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> IRInstruction(IOPCODE_MOVE_RESULT_PSEUDO_OBJECT);
        mov_result<span style="color:#f92672">-&gt;</span>set_dest(move_result_it<span style="color:#f92672">-&gt;</span>insn<span style="color:#f92672">-&gt;</span>dest());
        IRInstruction<span style="color:#f92672">*</span> init_isn <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> IRInstruction(OPCODE_INVOKE_DIRECT);
        init_isn<span style="color:#f92672">-&gt;</span>set_method(init)<span style="color:#f92672">-&gt;</span>set_srcs_size(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">-&gt;</span>set_src(
            <span style="color:#ae81ff">0</span>, move_result_it<span style="color:#f92672">-&gt;</span>insn<span style="color:#f92672">-&gt;</span>dest());
        m.replace(insn_it, {new_isn, mov_result, init_isn});
        m.remove(move_result_it);
</code></pre></div>
</div>
<p>Subscribe：<a href="https://lfkdsk.github.io/index.xml" target="_blank">lfkdsk's Blog</a></p>
<div style="height:50px"></div>
<div class="post-comments">
<div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://lfkdsk.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript>Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>
</div>
</article>
<script src="/js/highlight.pack.js"></script>
<script src="https://unpkg.com/quicklink@0.1.1/dist/quicklink.umd.js"></script>
<script>
  hljs.initHighlightingOnLoad();
  
  var posts = document.getElementById('posts-list');
  posts && quicklink({
    el: posts,
    priority: true,
  });
</script>
</body>
</html>
